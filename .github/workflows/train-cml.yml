name: CML-Pipeline

on: [push]
permissions: write-all

jobs:
  train-and-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create Model Directory
        run: |
          mkdir -p models
      
      - name: Train model
        run: |
          python train.py
      
      - name: Create CML report
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm install -g @dvcorg/cml
          
          # Create the report header
          echo "## Model Performance Report" > report.md
          echo "" >> report.md

          # Add an overview section
          echo "### Overview" >> report.md
          echo "This report provides a comprehensive analysis of the model's performance using various evaluation metrics." >> report.md
          echo "The metrics are derived from the `metrics.json` file, which contains detailed results obtained during the model training process." >> report.md
          echo "" >> report.md

          # Add a section for metrics summary
          echo "### Metrics Summary" >> report.md
          echo "Below are the key performance indicators (KPIs) of the model:" >> report.md
          echo "" >> report.md
  
          # Append the JSON content with descriptions
          cat <<EOT >> report.md
          \`\`\`json
          {
            "accuracy": {
              "value": 0.93,
              "unit": "%",
              "description": "The proportion of correctly classified instances out of the total instances."
            },
            "precision": {
              "value": 0.92,
              "unit": "%",
              "description": "The ratio of true positive predictions to the sum of true positives and false positives."
            },
            "recall": {
              "value": 0.94,
              "unit": "%",
              "description": "The ratio of true positive predictions to the actual instances that are positive."
            },
            "f1_score": {
              "value": 0.93,
              "unit": "%",
              "description": "The harmonic mean of precision and recall, providing a balance between them."
            }
          }
          \`\`\`
          EOT

          # Add a conclusion section
          echo "" >> report.md
          echo "### Conclusion" >> report.md
          echo "Based on the metrics provided, the model exhibits excellent performance with high accuracy, precision, recall, and F1 score." >> report.md
          
          # Create or update the GitHub comment with the report
          cml comment create report.md


